@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using PoMad.Data
@using PoMad.Models
@using PoMad.Services
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject DailyDataService DailyDataService
@inject NavigationManager NavigationManager

<h1>Dashboard</h1>

<div class="row">
    <div class="col-md-6">
        <h3>Monthly Weight</h3>
        <RadzenChart>
            <RadzenColumnSeries Data="_monthlyWeightData" CategoryProperty="Month" ValueProperty="Weight" Title="Weight" />
            <RadzenCategoryAxis>
                <RadzenAxisTitle Text="Month" />
            </RadzenCategoryAxis>
            <RadzenValueAxis>
                <RadzenAxisTitle Text="Weight" />
            </RadzenValueAxis>
        </RadzenChart>
    </div>
    <div class="col-md-6">
        <h3>Monthly Calories</h3>
        <RadzenChart>
            <RadzenColumnSeries Data="_monthlyCaloriesData" CategoryProperty="Month" ValueProperty="Calories" Title="Calories" />
            <RadzenCategoryAxis>
                <RadzenAxisTitle Text="Month" />
            </RadzenCategoryAxis>
            <RadzenValueAxis>
                <RadzenAxisTitle Text="Calories" />
            </RadzenValueAxis>
        </RadzenChart>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <h3>OMAD Days</h3>
        <RadzenDataGrid AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true" Data="_dailyDataList" TItem="DailyData">
            <Columns>
                <RadzenDataGridColumn TItem="DailyData" Property="Date" Title="Date" />
                <RadzenDataGridColumn TItem="DailyData" Property="Calories" Title="Calories" />
                <RadzenDataGridColumn TItem="DailyData" Property="Weight" Title="Weight" />
                <RadzenDataGridColumn TItem="DailyData" Property="DidOMAD" Title="Did OMAD" />
            </Columns>
        </RadzenDataGrid>
    </div>
</div>

@code {
    private List<DailyData> _dailyDataList;
    private List<MonthlyWeightData> _monthlyWeightData;
    private List<MonthlyCaloriesData> _monthlyCaloriesData;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user != null)
        {
            _dailyDataList = await DailyDataService.GetDailyDataForUserAsync(user.Id);
            GenerateMonthlyWeightData();
            GenerateMonthlyCaloriesData();
        }
    }

    private void GenerateMonthlyWeightData()
    {
        _monthlyWeightData = _dailyDataList
            .GroupBy(d => new { d.Date.Year, d.Date.Month })
            .Select(g => new MonthlyWeightData
                {
                    Month = $"{g.Key.Year}-{g.Key.Month:D2}",
                    Weight = (int)g.Average(d => d.Weight)
                })
            .ToList();
    }

    private void GenerateMonthlyCaloriesData()
    {
        _monthlyCaloriesData = _dailyDataList
            .GroupBy(d => new { d.Date.Year, d.Date.Month })
            .Select(g => new MonthlyCaloriesData
                {
                    Month = $"{g.Key.Year}-{g.Key.Month:D2}",
                    Calories = (int)g.Average(d => d.Calories)
                })
            .ToList();
    }

    public class MonthlyWeightData
    {
        public string Month { get; set; }
        public int Weight { get; set; }
    }

    public class MonthlyCaloriesData
    {
        public string Month { get; set; }
        public int Calories { get; set; }
    }
}